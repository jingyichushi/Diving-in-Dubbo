:NOTE-caption: ğŸ§©
:important-caption: ğŸ†

= Dubboæ³¨å†Œä¸­å¿ƒ

æ³¨å†Œä¸­å¿ƒåœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„ä½œç”¨ä¸¾è¶³è½»é‡ï¼Œæœ‰äº†å®ƒæœåŠ¡æä¾›è€…~Provider~å’Œæ³¨å†Œè€…~Consumer~å°±èƒ½æ„ŸçŸ¥å½¼æ­¤ã€‚ä»ä¸‹è¿°Dubboæ¶æ„å›¾ç¤ºä¸­å¯çŸ¥ï¼šâ‘ Provider
ä»å®¹å™¨å¯åŠ¨åçš„åˆå§‹åŒ–é˜¶æ®µä¾¿ä¼šå‘æ³¨å†Œä¸­å¿ƒå®Œæˆæ³¨å†Œæ“ä½œï¼›â‘¡Consumerå¯åŠ¨åˆå§‹åŒ–é˜¶æ®µå®Œæˆå¯¹æ‰€éœ€Providerçš„è®¢é˜…æ“ä½œï¼›â‘¢å¦å¤–åœ¨Providerå‘ç”Ÿå˜åŒ–ï¼Œéœ€è¦
é€šçŸ¥å¯¹åº”æ³¨å†Œäº†ç›‘å¬æ­¤å˜åŒ–çš„Consumerã€‚

image::res/imgs/dubbo_architecture.png[caption="å›¾ 1: ", title="Dubboæ¶æ„", alt="dubboæ¶æ„å›¾", width="650",]

[IMPORTANT]
====
Registryåªæ˜¯Consumerå’ŒProviderèƒ½æ„ŸçŸ¥å½¼æ­¤çŠ¶æ€å˜åŒ–çš„ä¸€ç§ä¾¿æ·é€”å¾„è€Œå·²ï¼Œå½¼æ­¤çš„å®é™…é€šè®¯äº¤äº’è¿‡ç¨‹æ˜¯ç›´æ¥è¿›è¡Œçš„ï¼ŒäºRegistryæ˜¯é€æ˜æ— æ„Ÿçš„ã€‚Provider çŠ¶æ€å‘ç”Ÿå˜åŒ–äº†ï¼Œä¼šç”±Registryä¸»åŠ¨æ¨é€è®¢é˜…äº†è¯¥Providerçš„Consumerä»¬ï¼Œè¿™ä¿è¯äº†Consumeræ„ŸçŸ¥ProviderçŠ¶æ€å˜åŒ–çš„åŠæ—¶æ€§ï¼Œå’Œå…·ä½“åŠ¡éœ€æ±‚é€»è¾‘äº¤äº’è§£è€¦ï¼Œä¹Ÿæå‡äº†ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚

Dubboä¸­å­˜åœ¨å¾ˆå¤šæ¦‚å¿µï¼Œæœ‰äº›ç†è§£èµ·æ¥å°±è§‰å¾—ç‰¹åˆ«è´¹åŠ²ã€‚å¦‚æœ¬æ–‡çš„``Registry``ï¼Œç¿»è¯‘è¿‡æ¥çš„æ„æ€æ˜¯``æ³¨å†Œä¸­å¿ƒ``ï¼Œä½†å®ƒæ˜¯åº”ç”¨æœ¬åœ°çš„ï¼ŒçœŸæ­£çš„æ³¨å†Œä¸­å¿ƒæ˜¯å…¶ä»–ç‹¬ç«‹éƒ¨ç½²çš„è¿›ç¨‹ï¼Œæˆ–è¿›ç¨‹ç»„æˆçš„é›†ç¾¤ï¼Œæ¯”å¦‚``Zookeeper``ã€‚æœ¬åœ°çš„``Registry``é€šè¿‡å’Œ``Zookeeper``ç­‰è¿›è¡Œå®æ—¶çš„ä¿¡æ¯åŒæ­¥ï¼Œç»´æŒè¿™äº›å†…å®¹çš„ä¸€è‡´æ€§ï¼Œä»è€Œå®ç°äº†``æ³¨å†Œä¸­å¿ƒ``è¿™ä¸ªç‰¹æ€§ã€‚å¦å¤–å°±``Registry``è€Œè¨€ï¼Œ``Consumer``å’Œ``Provider``åªæ˜¯ä¸ªç”¨æˆ·è§†è§‰çš„æ¦‚å¿µï¼Œä»–ä»¬ä¸€å¾‹è¢«çœ‹åšæ˜¯ä¸€ä»½``URL``æ•°æ®ã€‚
====

== Registryå®šä¹‰

æ³¨å†Œä¸­å¿ƒå®ç°ç›®å‰åœ¨ä¸šç•Œæ˜¯ä¸€ä»¬æ¯”è¾ƒæˆç†Ÿçš„æŠ€æœ¯ï¼Œæœ‰å¤šç§æ–¹æ¡ˆï¼Œä¸ºäº†ææ¸…æ¥šDubboçš„æ³¨å†Œä¸­å¿ƒåˆ°åº•æ˜¯å¦‚ä½•è¿ä½œçš„ï¼Œæœ¬æ–‡å°†æ ¹æ®``AbstractRegistry``æºç è¿›è¡Œ
é€æ­¥è§£æã€‚åœ¨è¿›ä¸€æ­¥é˜è¿°ä¹‹å‰å…ˆçœ‹çœ‹å…¶å®ç°æ¥å£çš„å®šä¹‰
[source,java]
----
public interface RegistryService {

    /**
     * æ³¨å†Œæ•°æ®ï¼Œæ¯”å¦‚ï¼šæä¾›è€…åœ°å€ï¼Œæ¶ˆè´¹è€…åœ°å€ï¼Œè·¯ç”±è§„åˆ™ï¼Œè¦†ç›–è§„åˆ™ï¼Œç­‰æ•°æ®ã€‚
     *
     * æ³¨å†Œéœ€å¤„ç†å¥‘çº¦ï¼š<br>
     * 1. å½“URLè®¾ç½®äº†check=falseæ—¶ï¼Œæ³¨å†Œå¤±è´¥åä¸æŠ¥é”™ï¼Œåœ¨åå°å®šæ—¶é‡è¯•ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚<br>
     * 2. å½“URLè®¾ç½®äº†dynamic=falseå‚æ•°ï¼Œåˆ™éœ€æŒä¹…å­˜å‚¨ï¼Œå¦åˆ™ï¼Œå½“æ³¨å†Œè€…å‡ºç°æ–­ç”µç­‰æƒ…å†µå¼‚å¸¸é€€å‡ºæ—¶ï¼Œéœ€è‡ªåŠ¨åˆ é™¤ã€‚<br>
     * 3. å½“URLè®¾ç½®äº†category=routersæ—¶ï¼Œè¡¨ç¤ºåˆ†ç±»å­˜å‚¨ï¼Œç¼ºçœç±»åˆ«ä¸ºprovidersï¼Œå¯æŒ‰åˆ†ç±»éƒ¨åˆ†é€šçŸ¥æ•°æ®ã€‚<br>
     * 4. å½“æ³¨å†Œä¸­å¿ƒé‡å¯ï¼Œç½‘ç»œæŠ–åŠ¨ï¼Œä¸èƒ½ä¸¢å¤±æ•°æ®ï¼ŒåŒ…æ‹¬æ–­çº¿è‡ªåŠ¨åˆ é™¤æ•°æ®ã€‚<br>
     * 5. å…è®¸URIç›¸åŒä½†å‚æ•°ä¸åŒçš„URLå¹¶å­˜ï¼Œä¸èƒ½è¦†ç›–ã€‚<br>
     *
     * @param url æ³¨å†Œä¿¡æ¯ï¼Œä¸å…è®¸ä¸ºç©ºï¼Œå¦‚ï¼šdubbo://10.20.153.10/com.alibaba.foo.BarService?version=1.0.0&application=kylin
     */
    void register(URL url);

    /**
     * å–æ¶ˆæ³¨å†Œ.
     *
     * å–æ¶ˆæ³¨å†Œéœ€å¤„ç†å¥‘çº¦ï¼š<br>
     * 1. å¦‚æœæ˜¯dynamic=falseçš„æŒä¹…å­˜å‚¨æ•°æ®ï¼Œæ‰¾ä¸åˆ°æ³¨å†Œæ•°æ®ï¼Œåˆ™æŠ›IllegalStateExceptionï¼Œå¦åˆ™å¿½ç•¥ã€‚<br>
     * 2. æŒ‰å…¨URLåŒ¹é…å–æ¶ˆæ³¨å†Œã€‚<br>
     *
     * @param url æ³¨å†Œä¿¡æ¯ï¼Œä¸å…è®¸ä¸ºç©ºï¼Œå¦‚ï¼šdubbo://10.20.153.10/com.alibaba.foo.BarService?version=1.0.0&application=kylin
     */
    void unregister(URL url);

    /**
     * è®¢é˜…ç¬¦åˆæ¡ä»¶çš„å·²æ³¨å†Œæ•°æ®ï¼Œå½“æœ‰æ³¨å†Œæ•°æ®å˜æ›´æ—¶è‡ªåŠ¨æ¨é€.
     *
     * è®¢é˜…éœ€å¤„ç†å¥‘çº¦ï¼š<br>
     * 1. å½“URLè®¾ç½®äº†check=falseæ—¶ï¼Œè®¢é˜…å¤±è´¥åä¸æŠ¥é”™ï¼Œåœ¨åå°å®šæ—¶é‡è¯•ã€‚<br>
     * 2. å½“URLè®¾ç½®äº†category=routersï¼Œåªé€šçŸ¥æŒ‡å®šåˆ†ç±»çš„æ•°æ®ï¼Œå¤šä¸ªåˆ†ç±»ç”¨é€—å·åˆ†éš”ï¼Œå¹¶å…è®¸æ˜Ÿå·é€šé…ï¼Œè¡¨ç¤ºè®¢é˜…æ‰€æœ‰åˆ†ç±»æ•°æ®ã€‚<br>
     * 3. å…è®¸ä»¥interface,group,version,classifierä½œä¸ºæ¡ä»¶æŸ¥è¯¢ï¼Œå¦‚ï¼šinterface=com.alibaba.foo.BarService&version=1.0.0<br>
     * 4. å¹¶ä¸”æŸ¥è¯¢æ¡ä»¶å…è®¸æ˜Ÿå·é€šé…ï¼Œè®¢é˜…æ‰€æœ‰æ¥å£çš„æ‰€æœ‰åˆ†ç»„çš„æ‰€æœ‰ç‰ˆæœ¬ï¼Œæˆ–ï¼šinterface=*&group=*&version=*&classifier=*<br>
     * 5. å½“æ³¨å†Œä¸­å¿ƒé‡å¯ï¼Œç½‘ç»œæŠ–åŠ¨ï¼Œéœ€è‡ªåŠ¨æ¢å¤è®¢é˜…è¯·æ±‚ã€‚<br>
     * 6. å…è®¸URIç›¸åŒä½†å‚æ•°ä¸åŒçš„URLå¹¶å­˜ï¼Œä¸èƒ½è¦†ç›–ã€‚<br>
     * 7. å¿…é¡»é˜»å¡è®¢é˜…è¿‡ç¨‹ï¼Œç­‰ç¬¬ä¸€æ¬¡é€šçŸ¥å®Œåå†è¿”å›ã€‚<br>
     *
     * @param url è®¢é˜…æ¡ä»¶ï¼Œä¸å…è®¸ä¸ºç©ºï¼Œå¦‚ï¼šconsumer://10.20.153.10/com.alibaba.foo.BarService?version=1.0.0&application=kylin
     * @param listener å˜æ›´äº‹ä»¶ç›‘å¬å™¨ï¼Œä¸å…è®¸ä¸ºç©º
     */
    void subscribe(URL url, NotifyListener listener);

    /**
     * å–æ¶ˆè®¢é˜….
     *
     * å–æ¶ˆè®¢é˜…éœ€å¤„ç†å¥‘çº¦ï¼š<br>
     * 1. å¦‚æœæ²¡æœ‰è®¢é˜…ï¼Œç›´æ¥å¿½ç•¥ã€‚<br>
     * 2. æŒ‰å…¨URLåŒ¹é…å–æ¶ˆè®¢é˜…ã€‚<br>
     *
     * @param url è®¢é˜…æ¡ä»¶ï¼Œä¸å…è®¸ä¸ºç©ºï¼Œå¦‚ï¼šconsumer://10.20.153.10/com.alibaba.foo.BarService?version=1.0.0&application=kylin
     * @param listener å˜æ›´äº‹ä»¶ç›‘å¬å™¨ï¼Œä¸å…è®¸ä¸ºç©º
     */
    void unsubscribe(URL url, NotifyListener listener);

    /**
     * æŸ¥è¯¢ç¬¦åˆæ¡ä»¶çš„å·²æ³¨å†Œæ•°æ®ï¼Œä¸è®¢é˜…çš„æ¨æ¨¡å¼ç›¸å¯¹åº”ï¼Œè¿™é‡Œä¸ºæ‹‰æ¨¡å¼ï¼Œåªè¿”å›ä¸€æ¬¡ç»“æœã€‚
     *
     * @see com.alibaba.dubbo.registry.NotifyListener#notify(List)
     * @param url æŸ¥è¯¢æ¡ä»¶ï¼Œä¸å…è®¸ä¸ºç©ºï¼Œå¦‚ï¼šconsumer://10.20.153.10/com.alibaba.foo.BarService?version=1.0.0&application=kylin
     * @return å·²æ³¨å†Œä¿¡æ¯åˆ—è¡¨ï¼Œå¯èƒ½ä¸ºç©ºï¼Œå«ä¹‰åŒ{@link com.alibaba.dubbo.registry.NotifyListener#notify(List<URL>)}çš„å‚æ•°ã€‚
     */
    List<URL> lookup(URL url);

}
----

== å…·ä½“å®ç°

åœ¨Dubboä¸­æ³¨å†Œä¸­å¿ƒçš„å®ç°æ–¹å¼æœ‰å¤šç§ï¼ŒåŒ…æ‹¬ï¼šâ‘ Zookeeperï¼›â‘¡Etcdï¼›â‘¢Consulï¼›â‘£Redisï¼›â‘¤Multicastã€‚å¦‚ä¸Šæ–‡æ‰€ç¤ºï¼Œä»–ä»¬æä¾›çš„æœ€åŸºç¡€çš„åŠŸèƒ½å°±æ˜¯
"æ³¨å†Œã€è®¢é˜…ã€é€šçŸ¥"è¿™ä¸‰é¡¹ï¼Œæœ‰ç€å¾ˆå¼ºçš„å…±æ€§ã€‚æœ€ååœ¨å¾®æœåŠ¡è¿™ç§åˆ†å¸ƒå¼æ¶æ„ç³»ç»Ÿä¸­ï¼Œå®¹é”™å¤„ç†ä¸å¯æˆ–ç¼ºï¼Œæ³¨å†Œä¸­å¿ƒä½¿ç”¨æœ¬åœ°ç¼“å­˜æ–‡ä»¶ä½œä¸ºå®¹é”™æœºåˆ¶ã€‚ä»¥ä¸‹å°†
ä»è¿™4æ–¹é¢åˆ†å¼€é˜è¿°ã€‚

[NOTE]
Dubboä¸­ï¼ŒURLçš„æœ‰ç€å¾ˆå¼ºçš„é€šç”¨æ€§ï¼Œå®ƒ##å¯ä»¥å®Œå…¨ç”¨äºè¡¨å¾æŸç±»å‹çš„èŠ‚ç‚¹##ï¼Œæ¯”å¦‚Consumerã€Provider

[small]#æœ¬æ–‡ä¸­Consumerå’ŒProviderä»£è¡¨å¹¶ä¸å®Œå…¨å°±æ˜¯å¾®æœåŠ¡ä¸­æ‰€æŒ‡çš„æœåŠ¡æ¶ˆè´¹ç«¯å’ŒæœåŠ¡æä¾›ç«¯ï¼Œæ˜¯ç›¸å¯¹äºæ³¨å†Œã€è®¢é˜…å’Œé€šçŸ¥è¿™ä¸‰ä¸ªæ“ä½œè€Œè¨€çš„ï¼Œä»»æ„èŠ‚ç‚¹Nodeéƒ½å¯ä»¥
æ ¹æ®è‡ªèº«éœ€è¦åœ¨Registryæ³¨å†ŒæˆProvideræˆ–è€…è®¢é˜…å®ƒæ‰€æ„Ÿå…´è¶£çš„ç”±å…¶å®ƒProviderè§¦å‘çš„äº‹ä»¶ã€‚#


==== æ‰«ç›²â€”â€”URLã€Unmodifiable Viewã€Node
1. URLï¼Œç»Ÿä¸€èµ„æºå®šä½ç¬¦ï¼Œé¡¾åæ€ä¹‰æ˜¯ä¸€ä¸ªåœ¨ç³»ç»Ÿæ¡†æ¶ä¸­å”¯ä¸€ç•Œå®šèµ„æºçš„æ ‡è¯†ç¬¦^å¯ä»¥ç®€å•ç†è§£ä¸ºå­—ç¬¦ä¸²^ï¼Œåœ¨Dubboä¸­URLæ˜¯ä¸€ä¸ªå¤æ‚çš„å­˜åœ¨ï¼Œä½œä¸ºå…¬å…±å¥‘çº¦çš„
æ‰¿è½½ä½“^æˆ–ç§°ï¼šç»Ÿä¸€é…ç½®æ¨¡å‹ã€é…ç½®æ€»çº¿^ï¼Œå…·ä½“å‚è€ƒï¼š https://dubbo.apache.org/zh-cn/blog/introduction-to-dubbo-url.html[URL ç»Ÿä¸€æ¨¡å‹ @ *Dubbo*]
2. å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå³ä¾¿çº¿ç¨‹å®‰å…¨çš„å®¹å™¨ï¼Œç®€å•çš„é€šè¿‡è·å–å…¶å¼•ç”¨ï¼Œåç»­å¯¹å…¶è¿­ä»£ï¼Œè¿­ä»£è¿‡ç¨‹ä¸­ï¼Œå…¶æ‰€å«å…ƒç´ ~åŒ…æ‹¬ä¸ªæ•°åŠå†…å®¹~å¯èƒ½éšæ—¶ä¼šæ”¹å˜ï¼Œä¸ºäº†è·å¾—æ‰€åœ¨çº¿ç¨‹
çš„å½“ä¸‹è§†å›¾ï¼Œéœ€è¦ä½¿ç”¨åˆ°Javaé›†åˆæ¡†æ¶æä¾›çš„``unmodifiableXXX``è¾…åŠ©æ–¹æ³•å–å¾—å½“ä¸‹éå¯å˜è§†å›¾ï¼Œå¦‚ä¸‹ï¼š

[source,java]
----
public Set<URL> getRegistered() {
    return Collections.unmodifiableSet(registered);
}

public Map<URL, Set<NotifyListener>> getSubscribed() {
    return Collections.unmodifiableMap(subscribed);
}

public Map<URL, Map<String, List<URL>>> getNotified() {
    return Collections.unmodifiableMap(notified);
}
----

3.åœ¨Dubboä¸­ï¼ŒRegistryã€Consumerã€Providerç­‰èƒ½å¤Ÿç‹¬ç«‹éƒ¨ç½²çš„èŠ‚ç‚¹ï¼Œå‡è¢«è¡¨ç¤ºä¸ºNodeèŠ‚ç‚¹ï¼Œå„ä¸ªå…·ä½“å®ç°èŠ‚ç‚¹éœ€è¦å‘å¾€æä¾›è·å–è‡ªèº«URLã€å¯ç”¨çŠ¶æ€
æ£€æŸ¥çš„æ–¹æ³•ï¼Œä»¥åŠé”€æ¯æ“ä½œï¼Œå¦‚ä¸‹ï¼š

[source,java]
----
public interface Node {

    URL getUrl();

    boolean isAvailable();

    void destroy();
}
----
[[sec_url_isMatch]]
==== æ‰«ç›²â€”â€”`Consumer` å’Œ `Provider` çš„åŒ¹é…

``Registry``å®ç°ä¸­ï¼Œä½¿ç”¨``UrlUtils.isMatch(consumerUrl, providerUrl)``æ¥æ£€æŸ¥``Consumer``å’Œ``Provider``çš„åŒ¹é…é—®é¢˜ï¼Œå…¶ä»£ç å®ç°è™½ç„¶å¾ˆçŸ­ï¼Œä½†æ²¡é‚£ä¹ˆå®¹æ˜“ç†è§£ï¼Œå’Œè®¢é˜…ã€é€šçŸ¥å¯†åˆ‡ç›¸å…³ï¼Œæœ‰å¿…è¦åœ¨è¿™è¾¹å‰–æä¸€ä¸‹å…¶ç»†èŠ‚ã€‚

é¦–å…ˆæ˜¯å…³äº``Service Key``çš„å–å€¼ï¼Œä¸‹è¿°ä¸¤ä¸ªURLå¯¹åº”çš„å€¼åˆ†åˆ«ä¸º``com.dubbo.interfaceName^â‘ ^``å’Œ``org.dubbo.interfaceName^â‘¡^``ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨``path``å’Œå‚æ•°``interface``äºŒè€…ä¸­ï¼Œä¼˜å…ˆå–åè€…ã€‚äºConsumeræ¥è¯´ï¼Œå¯ä»¥ä½¿ç”¨``interface``ä½œä¸ºè¢«å¼•ç”¨å¾®æœåŠ¡çš„æ ‡è¯†ï¼Œè€Œ``path``ç•™ä½œå®ƒç”¨ã€‚

[source,java]
----
//â‘ 
dubbo://admin:hello1234@10.20.130.230:20880/org.dubbo.interfaceName?interface=com.dubbo.interfaceName&group=group1&version=1.0.0
//â‘¡
dubbo://admin:hello1234@10.20.130.230:20880/org.dubbo.interfaceName?group=group1&version=1.0.0
----

å¦å¤–æ–¹æ³•ä¸­è¿˜ç”¨åˆ°äº†``isMatchCategory(category, categories)``ï¼Œæ ¹æ®å…¶å®šä¹‰çš„è§„åˆ™ï¼Œä¸‹è¿°æƒ…å†µä¸‹``category``æ˜¯å’Œ``categories``åŒ¹é…çš„ï¼š

. `categories` å€¼ä¸ºç©ºï¼Œ`category` å€¼ä¸º `"providers"`ï¼›
. `categories` å€¼ä¸º `"*"` ï¼›
. `categories` ä¸åŒ…å« `"\_" + category`ï¼ˆå«"_"çš„æƒ…å†µä¸‹)ï¼›
. `categories` åŒ…å« æˆ– ç­‰äº `category`ï¼›

æ€»ä½“è€Œè¨€ï¼ŒæŒ‰ä¼˜å…ˆé¡ºåºï¼ŒäºŒè€…éœ€è¦åœ¨``Service Key``ã€``category``ã€``enabled``ã€``group``ã€``version``ã€``classifier``è¿™å‡ é¡¹å‡åŒ¹é…ã€‚
[source,java]
----
public static boolean isMatch(URL consumerUrl, URL providerUrl) {
    String consumerInterface = consumerUrl.getServiceInterface();
    String providerInterface = providerUrl.getServiceInterface();

    //ç­‰ä»·äº consumerI != * && providerI != * && consumerI != providerI
    //ä¹Ÿå°±æ˜¯consumerIå’ŒproviderIéƒ½æ²¡æœ‰è®¾ç½®ä¸ºé€šé…ç¬¦æ—¶ï¼ŒäºŒè€…åˆä¸ç›¸ç­‰çš„æƒ…å†µï¼Œè‚¯å®šä¸åŒ¹é…
    if (!(ANY_VALUE.equals(consumerInterface)
            || ANY_VALUE.equals(providerInterface)
            || StringUtils.isEquals(consumerInterface, providerInterface))) {
        return false;
    }

    //è‹¥é…ç½®çš„consumeré…ç½®çš„categoryèŒƒå›´ä¸åŒ…å«provideræ‰€é…ç½®ï¼Œä¹Ÿä¸åŒ¹é…
    if (!isMatchCategory(providerUrl.getParameter(CATEGORY_KEY, DEFAULT_CATEGORY),
            consumerUrl.getParameter(CATEGORY_KEY, DEFAULT_CATEGORY))) {
        return false;
    }

    //è‹¥provideré…ç½®äº†enabled=falseï¼Œè€Œconsumeræ²¡æœ‰é…ç½®enabled=*ï¼Œåˆ™ä¹Ÿä¸åŒ¹é…
    if (!providerUrl.getParameter(ENABLED_KEY, true)
            && !ANY_VALUE.equals(consumerUrl.getParameter(ENABLED_KEY))) {
        return false;
    }

    String consumerGroup = consumerUrl.getParameter(GROUP_KEY);
    String consumerVersion = consumerUrl.getParameter(VERSION_KEY);
    String consumerClassifier = consumerUrl.getParameter(CLASSIFIER_KEY, ANY_VALUE);

    String providerGroup = providerUrl.getParameter(GROUP_KEY);
    String providerVersion = providerUrl.getParameter(VERSION_KEY);
    String providerClassifier = providerUrl.getParameter(CLASSIFIER_KEY, ANY_VALUE);

    //æœ€åè¿™é‡Œè¦æ±‚groupã€versionã€è¿˜æœ‰consumerClassifierå‡èƒ½åŒ¹é…
    //åœ¨consumerä¸€ç«¯ï¼Œä¸‰è€…å‡èƒ½ä½¿ç”¨é€šé…ç¬¦ï¼Œé€šé…ç¬¦è¡¨ç¤ºåŒ¹é…ä»»ä½•å€¼
    return (ANY_VALUE.equals(consumerGroup)
                || StringUtils.isEquals(consumerGroup, providerGroup)
                || StringUtils.isContains(consumerGroup, providerGroup))
            && (ANY_VALUE.equals(consumerVersion)
                || StringUtils.isEquals(consumerVersion, providerVersion))
            && (consumerClassifier == null
                || ANY_VALUE.equals(consumerClassifier)
                || StringUtils.isEquals(consumerClassifier, providerClassifier));
}


public static boolean isMatchCategory(String category, String categories) {
    if (categories == null || categories.length() == 0) {
        return DEFAULT_CATEGORY.equals(category);
    } else if (categories.contains(ANY_VALUE)) {
        return true;
    } else if (categories.contains(REMOVE_VALUE_PREFIX)) {
        return !categories.contains(REMOVE_VALUE_PREFIX + category);
    } else {
        return categories.contains(category);
    }
}
----
=== æ³¨å†Œ
Provideråœ¨å¯åŠ¨åçš„åˆå§‹åŒ–é˜¶æ®µï¼Œä¼šä¸»åŠ¨å‘æ³¨å†Œä¸­å¿ƒæäº¤æ³¨å†Œä¿¡æ¯ï¼ŒåŒæ ·ï¼Œéœ€è¦ä¸‹çº¿å¤„ç†æ—¶ï¼Œä¹Ÿä¼šä¸»åŠ¨å‘å‡ºæ³¨é”€ç”³è¯·ã€‚
Provideræ³¨å†Œç›¸å…³çš„é€»è¾‘å…¶å®å¾ˆç®€å•ï¼Œå¦‚ä¸‹ï¼š
[source,java]
----
public abstract class AbstractRegistry implements Registry {

    private final Set<URL> registered = new ConcurrentHashSet<>();
    ...

    public void register(URL url) {
        if (url == null) {
            throw new IllegalArgumentException("register url == null");
        }
        registered.add(url);
    }

    public void unregister(URL url) {
        if (url == null) {
            throw new IllegalArgumentException("unregister url == null");
        }
        registered.remove(url);
    }

    public void destroy() {

        Set<URL> destroyRegistered = new HashSet<>(getRegistered());
        if (!destroyRegistered.isEmpty()) {
            for (URL url : destroyRegistered) {
                //å½“URLè®¾ç½®äº†dynamic=falseå‚æ•°ï¼Œåˆ™éœ€æŒä¹…å­˜å‚¨ï¼Œå¦åˆ™ï¼Œå½“æ³¨å†Œè€…å‡ºç°æ–­ç”µç­‰æƒ…å†µå¼‚å¸¸é€€å‡ºæ—¶ï¼Œéœ€è‡ªåŠ¨åˆ é™¤ã€‚
                if (url.getParameter(Constants.DYNAMIC_KEY, true)) {
                    try {
                        unregister(url);
                    } catch (Throwable t) {
                        logger.warn("Failed to unregister url " + url + " to registry "
                            + getUrl() + " on destroy, cause: "
                             + t.getMessage(), t);
                    }
                }
            }
        }
        ...
    }

    //æ¢å¤æ–¹æ³•ï¼Œåœ¨æ³¨å†Œä¸­å¿ƒæ–­å¼€ï¼Œé‡è¿æˆåŠŸçš„æ—¶å€™
    protected void recover() throws Exception {
        //æŠŠå†…å­˜ç¼“å­˜ä¸­çš„registeredå–å‡ºæ¥éå†è¿›è¡Œæ³¨å†Œ
        Set<URL> recoverRegistered = getRegistered();
        if (!recoverRegistered.isEmpty()) {
            for (URL url : recoverRegistered) {
                register(url);
            }
        }
        ...
    }
    ...
}
----
ä»ä¸Šè¿°æºç å¯çŸ¥ï¼ŒDubboä½¿ç”¨äº†å¹¶å‘åŒ…ä¸‹çš„``ConcurrentHashSet``ä½œä¸ºæ‰€æœ‰Providerçš„æ³¨å†Œä¿¡æ¯å®¹å™¨ï¼Œç¡®ä¿äº†çº¿ç¨‹å®‰å…¨å’ŒProvideræ³¨å†Œèµ„æºURLçš„å…¨å±€å”¯
ä¸€æ€§ã€‚

[NOTE]
====

.``recover()``æºç ç–‘æƒ‘è§£æ

ä¸Šè¿°å…³äºrecoverçš„ä»£ç ç‰‡æ®µï¼Œå•çœ‹èµ·æ¥ä¼šè§‰å¾—å¾ˆè¹Šè··ï¼Œåœ¨è¯•å›¾æ¢å¤æ—¶ï¼Œä»…ä»…ç®€å•åœ°ä»å†…å­˜ç¼“å­˜ä¸­è·å–äº†æ‰€æœ‰å·²æ³¨å†Œproviderçš„URLè§†å›¾ï¼Œç„¶åé€ä¸ªè°ƒç”¨``register()``
é‡æ–°æ³¨å†Œï¼Œç„¶è€Œ``register()``ä¹Ÿä»…ä»…æ˜¯å°†URLåŠ å…¥åˆ°``registered``é›†åˆä¸­ã€‚

æ€»ä½“è€Œè¨€ï¼ŒJavaæ˜¯ä¸€é—¨çº¯OOPçš„ç¼–ç¨‹è¯­è¨€ï¼Œå…¶ç»§æ‰¿å’Œå¤šæ€ç‰¹æ€§ï¼Œå†³å®šäº†ä¸€ä¸ªå¯¹è±¡çš„æŸä¸ªæ–¹æ³•çš„å…·ä½“è¡Œä¸ºæœ€ç»ˆå–å†³äºè¯¥æ–¹æ³•çš„è¦†å†™è½¨è¿¹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¯¥æ–¹æ³•å®é™…çš„æ‰§è¡Œæ“ä½œç”±
è¿è¡Œæ—¶å¯¹è±¡å†³å®šçš„ï¼Œå¦‚æœå…¶å¯¹åº”ç±»è¦†å†™äº†çˆ¶ç±»æ–¹æ³•æ—¶ï¼Œè°ƒç”¨äº†``super.()``ï¼Œåˆ™çˆ¶ç±»çš„è¡Œä¸ºå¾—åˆ°ä¿ç•™ï¼Œå¦åˆ™ä¼šè¢«æ— æƒ…åœ°æ“¦é™¤ã€‚

æœ€ç»ˆçš„æ³¨å†Œä¸­å¿ƒå®ç°ç±»å¹¶ä¸æ˜¯ç›´æ¥ç»§æ‰¿äº``AbstractRegistry``çš„ï¼ŒDubboè¦æ±‚ç›¸åº”æ³¨å†Œä¸­å¿ƒèƒ½å¤Ÿæä¾›åŸºæœ¬çš„é‡è¯•æœºåˆ¶ä»¥ä¿è¯æ³¨å†Œä¸­å¿ƒçš„å¯ç”¨æ€§ã€‚``FailbackRegistry``
ä½œä¸ºå…¶ç›´æ¥ç»§æ‰¿ç±»ï¼Œè¦†å†™äº†``register()``æ–¹æ³•ï¼ŒåŒ…å«äº†ä¸€åºåˆ—é‡è¯•ç›¸å…³é€»è¾‘ï¼Œä¹ƒè‡³è°ƒç”¨æœ€ç»ˆåœ¨Zookeeperã€Etcdé›†ç¾¤å®Œæˆå®é™…æ³¨å†Œçš„``doRegister(URL url)``æ–¹æ³•ã€‚

====

=== è®¢é˜…
Consumeråœ¨å¯åŠ¨åçš„åˆå§‹åŒ–é˜¶æ®µï¼Œä¼šä¸»åŠ¨å‘æ³¨å†Œä¸­å¿ƒæäº¤è®¢é˜…è¯·æ±‚ï¼ŒåŒæ ·ï¼Œéœ€è¦ä¸‹çº¿å¤„ç†æ—¶ï¼Œä¹Ÿä¼šä¸»åŠ¨å‘å‡ºæ³¨é”€ç”³è¯·ã€‚æ¯ä¸€ä¸ªConsumeréƒ½æœ‰å”¯ä¸€çš„URLï¼Œå®ƒå¯ä»¥åŒæ—¶è®¢é˜…
å¤šä¸ªæ„Ÿå…´è¶£çš„äº‹ä»¶ï¼Œå…·ä½“å‚è€ƒä¸‹è¿°æºç ï¼š
[source,java]
----
public abstract class AbstractRegistry implements Registry {

    private final ConcurrentMap<URL, Set<NotifyListener>> subscribed = new ConcurrentHashMap<>();

    public void subscribe(URL url, NotifyListener listener) {
        if (url == null) {
            throw new IllegalArgumentException("subscribe url == null");
        }
        if (listener == null) {
            throw new IllegalArgumentException("subscribe listener == null");
        }
        Set<NotifyListener> listeners = subscribed.computeIfAbsent(url, n -> new ConcurrentHashSet<>());
        listeners.add(listener);
    }

    public void unsubscribe(URL url, NotifyListener listener) {
        if (url == null) {
            throw new IllegalArgumentException("unsubscribe url == null");
        }
        if (listener == null) {
            throw new IllegalArgumentException("unsubscribe listener == null");
        }
        Set<NotifyListener> listeners = subscribed.get(url);
        if (listeners != null) {
            listeners.remove(listener);
        }
    }


    //æ¢å¤æ–¹æ³•ï¼Œåœ¨æ³¨å†Œä¸­å¿ƒæ–­å¼€ï¼Œé‡è¿æˆåŠŸçš„æ—¶å€™
    protected void recover() throws Exception {
        ...
        //æŠŠå†…å­˜ç¼“å­˜ä¸­çš„subscribedå–å‡ºæ¥éå†è¿›è¡Œè®¢é˜…
        Map<URL, Set<NotifyListener>> recoverSubscribed = new HashMap<>(getSubscribed());
        if (!recoverSubscribed.isEmpty()) {
            for (Map.Entry<URL, Set<NotifyListener>> entry : recoverSubscribed.entrySet()) {
                URL url = entry.getKey();
                for (NotifyListener listener : entry.getValue()) {
                    subscribe(url, listener);
                }
            }
        }
    }

    public void destroy() {
        ...
        //æŠŠå†…å­˜ç¼“å­˜ä¸­çš„subscribedå–å‡ºæ¥éå†è¿›è¡Œå–æ¶ˆè®¢é˜…
        Map<URL, Set<NotifyListener>> destroySubscribed = new HashMap<>(getSubscribed());
        if (!destroySubscribed.isEmpty()) {
            for (Map.Entry<URL, Set<NotifyListener>> entry : destroySubscribed.entrySet()) {
                URL url = entry.getKey();
                for (NotifyListener listener : entry.getValue()) {
                    try {
                        unsubscribe(url, listener);
                    } catch (Throwable t) {
                        logger.warn("Failed to unsubscribe url " + url + " to registry "
                            + getUrl() + " on destroy, cause: " + t.getMessage(), t);
                    }
                }
            }
        }
    }
    ...
}
----
é€šè¿‡ä¸Šè¿°æºç å‘ç°Consumeråœ¨è®¢é˜…æ„Ÿå…´è¶£çš„äº‹ä»¶æ—¶ï¼Œä¼ å…¥çš„å‚æ•°åªåŒ…å«__URL__å’Œ__NotifyListener__ä¸¤ä¸ªå‚æ•°ï¼Œè¿™å’Œç›´è§‰æœ‰äº›å†²çªï¼Œè®¢é˜…çš„äº‹ä»¶åº”è¯¥æ¥è‡ª
æä¾›æœåŠ¡æŸäº›å€™é€‰çš„Providerï¼Œé‚£Dubboæ€ä¹ˆç¡®å®šæœ‰å“ªäº›å€™é€‰é¡¹å‘¢ï¼Ÿè¿™å¾—å›åˆ°ä¸Šæ–‡ä¸­æåˆ°``RegistryService``æ¥å£å®šä¹‰åŠURLå®ç°è¯­ä¹‰ä¸Šï¼Œå®é™…ä¸Šæ¥å£å®šä¹‰
è®²å¾—å¾ˆæ¸…æ¥šï¼Œ__URL__çš„__Pathéƒ¨åˆ†__æ ‡è¯†è®¢é˜…æœåŠ¡çš„__Consumer__ï¼Œè€Œ__Queryå‚æ•°éƒ¨åˆ†__åˆ™æ˜¯ç”¨äºåŒ¹é…å€™é€‰__Provider__çš„ã€‚

=== é€šçŸ¥
Consumerå’ŒProviderå‘Registryæä¾›äº†è®¢é˜…å’Œæ³¨å†Œæ•°æ®åï¼ŒRegistryä¼šåœ¨Providerçš„çŠ¶æ€å‘ç”Ÿäº†å˜åŒ–æ—¶ï¼Œæ ¹æ®Consumerçš„è®¢é˜…æƒ…å†µï¼Œè§¦å‘ç›¸å¯¹åº”äº‹ä»¶ï¼Œå°†
Consumeræ‰€æ„Ÿå…´è¶£çš„Provideræ•°æ®``notify()``ç»™Consumerã€‚åŒæ—¶Consumerä¹Ÿå¯ä»¥ä¸»åŠ¨``lookup()``è·å–æŸ¥è¯¢æ‰€åŒ¹é…çš„Provideræ•°æ®ã€‚æƒ³è¿›ä¸€æ­¥ææ¸…æ¥š
3è€…é—´å…³ç³»ï¼Œå…ˆçœ‹çœ‹å…¶æ•°æ®å®šä¹‰ï¼š

[source,java]
----

private final ConcurrentMap<URL, Set<NotifyListener>> subscribed
    = new ConcurrentHashMap<>();

private final Set<URL> registered
    = new ConcurrentHashSet<>();

//keyã€URLã€‘ï¼šè¡¨å¾Consumerçš„URL
//valueã€Map<String, List<URL>>ã€‘ï¼š
//  é”®ä¸ºåˆ†ç±»æ ‡è¯†ï¼Œå€¼ä¸ºè¯¥åˆ†ç±»ä¸‹æ‰€æœ‰å¯¹åº”Providerçš„URL
private final ConcurrentMap<URL, Map<String, List<URL>>> notified
    = new ConcurrentHashMap<>();
----

Providerå‘Registryæ³¨å†Œï¼Œæä¾›è‡ªèº«çš„è¡¨å¾ä¿¡æ¯URLï¼ŒConsumeråˆ™å‘Registryè®¢é˜…å…¶æ‰€å…³æ³¨çš„äº‹ä»¶``NotifyListener``ï¼Œåœ¨å‘ç”Ÿç›¸åº”äº‹ä»¶æ—¶ï¼ŒRegistryä¼š
å°†æ‰€æœ‰Providerè¡¨å¾ä¿¡æ¯URLæŒ‰Categoryåˆ†ç»„``notify()``ç»™Consumerã€‚ç„¶è€Œè¿™å¹¶ä¸æ˜¯å…¨è²Œï¼Œ``subscribed``é›†åˆçš„Keyä¸­è¿˜æ½œè—ç€å¦å¤–ä¸€å±‚å«ä¹‰ï¼Œå…¶URL
æºå¸¦çš„å‚æ•°ï¼Œç”¨äºæ˜ç¡®å‘ŠçŸ¥Registryï¼Œç¬¦åˆå“ªäº›ç‰¹å¾çš„Providerè¡¨å¾ä¿¡æ¯æ‰æ˜¯å®ƒæ‰€çœŸæ­£æ‰€å…³æ³¨çš„ã€‚ä¹Ÿå°±æ˜¯è¯´æœ‰äº†è¿™ä¸¤ç»„æ•°æ®ï¼Œå°±å¤§è‡´çŸ¥é“ProviderçŠ¶æ€æœ‰å˜åŠ¨æ—¶
è¯¥é€šçŸ¥å“ªäº›Consumeräº†ã€‚

``notified``ç”¨äºæŒ‰Categoryåˆ†ç»„è£…å¡«é‚£äº›æœ€è¿‘å·²ç»é€šçŸ¥è¿‡Consumerçš„æ‰€æœ‰Providerè¡¨å¾ä¿¡æ¯ï¼Œè¿™é‡Œè®°å½•çš„ä¿¡æ¯æ˜¯ä¾¿äºå®ç°``lookup()``çš„ã€‚

[source,java]
----

public interface NotifyListener {
    void notify(List<URL> urls);
}

public abstract class AbstractRegistry implements Registry {

    /**
     * Notify changes from the Provider side.
     *
     * @param url      consumer side url
     * @param listener listener
     * @param urls     provider latest urls
     */
    protected void notify(URL url, NotifyListener listener, List<URL> urls) {
        if (url == null) {
            throw new IllegalArgumentException("notify url == null");
        }
        if (listener == null) {
            throw new IllegalArgumentException("notify listener == null");
        }
        if ((CollectionUtils.isEmpty(urls))
                //æ„å³Consumerä¸æ˜¯åŒ¹é…ä»»æ„Interface
                && !Constants.ANY_VALUE.equals(url.getServiceInterface())) {
            logger.warn("Ignore empty notify urls for subscribe url " + url);
            return;
        }

        //æŒ‰CATEGORYè¿›è¡Œåˆ†ç»„ï¼Œå°†è¡¨å¾Providerçš„urlsä¸­Consumeræ„Ÿå…´è¶£çš„é‚£äº›è£…è¿›resultä¸­
        Map<String, List<URL>> result = new HashMap<>();
        for (URL u : urls) {
            //æ£€æµ‹Consumerå¯¹å½“å‰Provideræ˜¯å¦æ„Ÿå…´è¶£
            if (UrlUtils.isMatch(url, u)) {
                String category = u.getParameter(Constants.CATEGORY_KEY, Constants.DEFAULT_CATEGORY);
                List<URL> categoryList = result.computeIfAbsent(category, k -> new ArrayList<>());
                categoryList.add(u);
            }
        }
        if (result.size() == 0) {
            return;
        }

        //ä½¿ç”¨è¡¨å¾Consumerçš„urlè·å¾—å¯¹åº”æ„Ÿå…´è¶£çš„
        Map<String, List<URL>> categoryNotified = notified.computeIfAbsent(url, u -> new ConcurrentHashMap<>());
        for (Map.Entry<String, List<URL>> entry : result.entrySet()) {
            String category = entry.getKey();
            List<URL> categoryList = entry.getValue();

            //å°†ä¸Šè¿°æŒ‰CATEGORYåˆ†ç»„çš„æ‰€æœ‰Providerç½®å…¥notifiedä¸­
            categoryNotified.put(category, categoryList);

            //é’ˆå¯¹å½“å‰CATEGORYåˆ†ç»„ä¸‹çš„æ‰€æœ‰Providerå›è°ƒlistener
            listener.notify(categoryList);
            // We will update our cache file after each notification.
            // When our Registry has a subscribe failure due to network jitter, we can return at least the existing cache URL.
            saveProperties(url);
        }
    }

    //å½“å‚æ•°ä¸­æ‰€æœ‰providersä¿¡æ¯æœ‰å˜åŠ¨æ—¶ï¼Œé€šçŸ¥æ‰€æœ‰è®¢é˜…ä»–ä»¬çš„consumberä»¬è¿™ä¸€å˜åŠ¨
    //è¿™äº›providerså±äºåŒä¸€ä¸ªå¾®æœåŠ¡éƒ¨ç½²çš„å¤šä¸ªä¸åŒå®ä¾‹
    protected void notify(List<URL> urls) {
        if (CollectionUtils.isEmpty(urls)) {
            return;
        }

        for (Map.Entry<URL, Set<NotifyListener>> entry : getSubscribed().entrySet()) {
            URL url = entry.getKey();
            //è¿™é‡Œè¯´æ˜ä¼ å…¥çš„ä¸€ç»„URLæ˜¯ç±»ä¼¼çš„ï¼Œè¦ä¹ˆéƒ½èƒ½åŒ¹é…åˆ°Consumerï¼Œå¦åˆ™å…¨ä¸
            if (!UrlUtils.isMatch(url, urls.get(0))) {
                continue;
            }

            Set<NotifyListener> listeners = entry.getValue();
            if (listeners != null) {
                for (NotifyListener listener : listeners) {
                    try {
                        notify(url, listener, filterEmpty(url, urls));
                    } catch (Throwable t) {
                        logger.error("Failed to notify registry event, urls: " +
                            urls + ", cause: " + t.getMessage(), t);
                    }
                }
            }
        }
    }

    @Override
    public List<URL> lookup(URL url) {
        List<URL> result = new ArrayList<>();

        //å°†æ‰€æœ‰æŒ‰Categoryåˆ†ç»„å¥½çš„Providerçš„URLä¿¡æ¯è£…å…¥åˆ°ä¸€ç»´çš„resultä¸­
        Map<String, List<URL>> notifiedUrls = getNotified().get(url);
        if (notifiedUrls != null && notifiedUrls.size() > 0) {
            for (List<URL> urls : notifiedUrls.values()) {
                for (URL u : urls) {
                    if (!Constants.EMPTY_PROTOCOL.equals(u.getProtocol())) {
                        result.add(u);
                    }
                }
            }
        } else {
            //ä½¿ç”¨åŸå­å¼•ç”¨ç±»å‹ä¿å­˜Providerçš„URLä¿¡æ¯ï¼Œå°è£…åœ¨Listä¸­ï¼Œæœ€åˆå…¶å†…å®¹ä¸ºç©º
            final AtomicReference<List<URL>> reference = new AtomicReference<>();
            //ç”ŸæˆNotifyListenerï¼ŒDubboä¼šåœ¨ProvidersçŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶notifyç»™æ ¹æ®URLç‰¹å¾èƒ½åŒ¹é…çš„Consumer
            //listenerçš„å›è°ƒä»…ä»…æ˜¯å°†è·å–åˆ°Providers(List<URL>)è®¾ç½®åˆ°referenceä¸­è€Œå·²
            NotifyListener listener = reference::set;
            //å®Œæˆè®¢é˜…æ“ä½œï¼Œç¡®ä¿listenerèƒ½è¢«å›è°ƒåˆ°
            subscribe(url, listener); // Subscribe logic guarantees the first notify to return
            //è·å–referenceä¸­çš„å†…å®¹ï¼Œå¹¶å°†è·å–åˆ°å€¼è®¾åˆ°resultè¿”å›å€¼ä¸­ï¼Œæ„Ÿè§‰è¿™é‡Œå¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯æ— ç”¨çš„ï¼Œ
            //é™¤éå¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œåˆšå¥½è¦æ‰§è¡Œè¿™è¯­å¥çš„æ—¶å€™ï¼ŒCPUèµ„æºå·²ç»è®©æ¸¡ç»™å…¶å®ƒçº¿ç¨‹notifyæ“ä½œäº†
            List<URL> urls = reference.get();
            if (CollectionUtils.isNotEmpty(urls)) {
                for (URL u : urls) {
                    if (!Constants.EMPTY_PROTOCOL.equals(u.getProtocol())) {
                        result.add(u);
                    }
                }
            }
        }
        return result;
    }
    ...
}
----

=== å®¹é”™è®¾è®¡

[small]#We will update our cache file after each notification. When our Registry has a subscribe failure due to network jitter,
we can return at least the existing cache URL.#

åœ¨``notify()``å®ç°ä¸­ï¼Œæœ‰ä¸Šè¿°æ³¨é‡Šï¼Œå¤§æ„æ˜¯å› ä¸ºç½‘ç»œæŠ–åŠ¨å¯¼è‡´è®¢é˜…å¤±è´¥æ—¶ï¼Œä¸ºä¿è¯æœåŠ¡çš„å¯é æ€§ï¼Œä½œä¸ºæœ€æ¬¡çš„æ–¹æ¡ˆï¼Œè®¢é˜…è€…å¯å‘æ³¨å†Œä¸­å¿ƒè°ƒç”¨``public List<URL>
getCacheUrls(URL url)``è·å–æ‰€æœ‰åŒ¹é…åˆ°çš„æœ€è¿‘æ³¨å†Œåœ¨Registryçš„Providerçš„URLã€‚

åœ¨åˆ†å¸ƒå¼æ¶æ„ä¸­ï¼Œä½œä¸ºæ‹…çº²PRCé€šè®¯æ¡†æ¶çš„Dubboï¼Œå®ƒè§£å†³çš„æ˜¯å¾®æœåŠ¡é—´åä½œçš„éš¾é¢˜ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä»…ä»…ä½œä¸ºProviderå’ŒConsumerçš„ä¸€å¥—åŸºç¡€ä¾èµ–å’Œåº”ç”¨ä¸€èµ·æ‰“åŒ…
éƒ¨ç½²ï¼ŒDubboè‡ªèº«å¹¶æ²¡æœ‰å•ç‹¬éƒ¨ç½²ï¼Œæœ¬æ–‡æ‰€è¿°çš„Registryä¹Ÿä»…ä»…æ˜¯å…¶ä¸­ä¸€ä¸ªä¾èµ–æ¨¡å—ï¼Œç”±å…¶å®Œæˆåˆ°Zookeeperã€Etcdã€Consulç­‰Serverçš„æ³¨å†Œè®¢é˜…æ“ä½œã€‚

å¤§è‡´çš„è®¾è®¡æ–¹æ¡ˆå¦‚ä¸‹ï¼š
Registryåœ¨æ¯æ¬¡``notify()``é€šçŸ¥æ—¶ï¼Œå‡å°†å½“å‰è¢«__notify__çš„Consumerèƒ½åŒ¹é…åˆ°æ‰€æœ‰Providerçš„URLç»„æˆçš„Listå†™å…¥åˆ°__Properties__ä¸­ï¼Œå®ƒçš„Keyå€¼ä¸º
Consumerçš„URLä¸­è·å–åˆ°çš„__ServiceKey__ï¼Œæ ¹æ®éœ€æ±‚åŒæ­¥æˆ–å¼‚æ­¥åœ°å°†è¿™äº›å†…å®¹åœ¨æ–‡ä»¶é”çš„è¾…åŠ©ä¸‹äº’æ–¥åœ°ä¿å­˜åˆ°å¯¹åº”çš„``/.dubbo/dubbo-registry-[å½“å‰åº”ç”¨å]-[å½“å‰
Registryæ‰€åœ¨çš„IPåœ°å€].cache``æ–‡ä»¶ä¸­ã€‚ä¸ºäº†ç¡®ä¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æ–‡ä»¶çš„ä¿å­˜ä¸å‘ç”Ÿå†²çªï¼ŒDubboä½¿ç”¨äº†åŸºäºç‰ˆæœ¬å·çš„ä¹è§‚é”ï¼Œåªæœ‰è·å–åˆ°äº†æœ€æ–°çš„ç‰ˆæœ¬å·ï¼Œ
æ‰èƒ½æ‰§è¡Œã€‚

ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š
[source,java]
----
public abstract class AbstractRegistry implements Registry {

    private static final int MAX_RETRY_TIMES_SAVE_PROPERTIES = 3;

    private final AtomicInteger savePropertiesRetryTimes = new AtomicInteger();

    // Local disk cache, where the special key value.registries records the list of registry centers, and the others are the list of notified service providers
    private final Properties properties = new Properties();

    private final AtomicLong lastCacheChanged = new AtomicLong();

    //å°†æ–‡ä»¶ä¸­ç¼“å­˜çš„ä¿¡æ¯æ¢å¤åˆ°ç¼“å­˜propertiesä¸­
    private void loadProperties() {
        if (file != null && file.exists()) {
            InputStream in = null;
            try {
                in = new FileInputStream(file);
                properties.load(in);
                if (logger.isInfoEnabled()) {
                    logger.info("Load registry cache file " + file + ", data: " + properties);
                }
            } catch (Throwable e) {
                logger.warn("Failed to load registry cache file " + file, e);
            } finally {
                if (in != null) {
                    try {
                        in.close();
                    } catch (IOException e) {
                        logger.warn(e.getMessage(), e);
                    }
                }
            }
        }
    }


    private void saveProperties(URL url) {
        if (file == null) {
            return;
        }

        try {
            StringBuilder buf = new StringBuilder();
            Map<String, List<URL>> categoryNotified = notified.get(url);
            if (categoryNotified != null) {
                for (List<URL> us : categoryNotified.values()) {
                    for (URL u : us) {
                        if (buf.length() > 0) {
                            buf.append(URL_SEPARATOR);
                        }
                        buf.append(u.toFullString());
                    }
                }
            }
            properties.setProperty(url.getServiceKey(), buf.toString());
            long version = lastCacheChanged.incrementAndGet();
            if (syncSaveFile) {
                doSaveProperties(version);
            } else {
                registryCacheExecutor.execute(new SaveProperties(version));
            }
        } catch (Throwable t) {
            logger.warn(t.getMessage(), t);
        }
    }

    public void doSaveProperties(long version) {
        //åªæœ‰è·å¾—æœ€æ–°ç‰ˆæœ¬å·æ‰èƒ½æ‰§è¡Œä¿å­˜æ“ä½œ
        if (version < lastCacheChanged.get()) {
            return;
        }
        if (file == null) {
            return;
        }
        // Save
        try {
            //è·å–*.lockæ–‡ä»¶ï¼Œä¸å­˜åœ¨åˆ™æ–°å»º
            File lockfile = new File(file.getAbsolutePath() + ".lock");
            if (!lockfile.exists()) {
                lockfile.createNewFile();
            }
            //ç”±*.lockæ–‡ä»¶è·å–åˆ°å…¶æŒæœ‰çš„é”
            try (RandomAccessFile raf = new RandomAccessFile(lockfile, "rw");
                 FileChannel channel = raf.getChannel()) {
                FileLock lock = channel.tryLock();
                if (lock == null) {
                    throw new IOException("Can not lock the registry cache file " + file.getAbsolutePath() + ", ignore and retry later, maybe multi java process use the file, please config: dubbo.registry.file=xxx.properties");
                }
                // Save
                try {
                    if (!file.exists()) {
                        file.createNewFile();
                    }

                    //ä½¿ç”¨store()æ“ä½œä¿å­˜Propertiesåˆ°æ–‡ä»¶ä¸­
                    try (FileOutputStream outputFile = new FileOutputStream(file)) {
                        properties.store(outputFile, "Dubbo Registry Cache");
                    }
                } finally {
                    //é‡Šæ”¾æ–‡ä»¶é”
                    lock.release();
                }
            }
        } catch (Throwable e) {
            //å¦‚æœå› é”è·å–å¤±è´¥ç­‰åŸå› å¯¼è‡´çš„å¼‚å¸¸ï¼Œå¯¹å½“å‰æ“ä½œè¿›è¡Œé‡è¯•å¤„ç†
            savePropertiesRetryTimes.incrementAndGet();
            if (savePropertiesRetryTimes.get() >= MAX_RETRY_TIMES_SAVE_PROPERTIES) {
                logger.warn("Failed to save registry cache file after retrying " + MAX_RETRY_TIMES_SAVE_PROPERTIES + " times, cause: " + e.getMessage(), e);
                savePropertiesRetryTimes.set(0);
                return;
            }
            if (version < lastCacheChanged.get()) {
                savePropertiesRetryTimes.set(0);
                return;
            } else {
                registryCacheExecutor.execute(new SaveProperties(lastCacheChanged.incrementAndGet()));
            }
            logger.warn("Failed to save registry cache file, will retry, cause: " + e.getMessage(), e);
        }
    }
    ...
}
----
[small]#å‡å¦‚å·²ç»æœ‰ä¸€ä¸ªçº¿ç¨‹æ•´åœ¨æ‰§è¡Œ``doSaveProperties()``æ“ä½œï¼Œå·²ç»æ‰§è¡Œåˆ°"// Save"è¿™ä¸ªä½ç½®ï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹ä¹Ÿè§†å›¾å‘èµ·è¯¥æ“ä½œï¼Œç”±äºå®ƒä¼šè·å¾—æœ€æ–°çš„
versionï¼Œå› æ­¤å®ƒä¹Ÿèƒ½ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œè¿™æ—¶å°±å¾ˆæœ‰å¯èƒ½å‘ç”Ÿå…±äº«èµ„æºçš„äº‰ç”¨ï¼Œæ¥ä¸‹æ¥ä½¿ç”¨çš„æ–‡ä»¶é”åˆšå¥½ä¿è¯äº†è¿™ç§äº’æ–¥æ€§ã€‚#

Dubboä¸ºäº†é˜²æ­¢ookeeperç­‰çš„æ³¨å†Œä¸­å¿ƒå‡ºç°ç½‘ç»œæŠ–åŠ¨æƒ…å†µè€Œå¯¼è‡´Consumerè®¢é˜…æ“ä½œæ— æ³•é¡ºåˆ©è¿›è¡Œéœ€è¦ä»¥æ–‡ä»¶çš„æ–¹å¼ç¼“å­˜
æœ€æ–°ConsumeråŒ¹é…åˆ°çš„Providerçš„URLä¿¡æ¯ï¼Œåœ¨æ¯æ¬¡``notify()``éƒ½ä¼šè°ƒç”¨``saveProperties()``å°†æœ€æ–°æ•°æ®ä¿å­˜èµ·æ¥ã€‚
æ€»æ‰€å‘¨çŸ¥ï¼ŒIOæ˜¯æ¯”è¾ƒè´¹æ—¶çš„ï¼Œè¿™åŠ¿å¿…é™ä½æ•ˆç‡ï¼Œå› è€Œå¦å¤–æä¾›ä¸€ä¸ªå¼‚æ­¥ä¿å­˜è¿™äº›æ•°æ®åˆ°*.propertiesæ–‡ä»¶çš„æ“ä½œã€‚
[source,java]
----
public abstract class AbstractRegistry implements Registry {
    // File cache timing writing
    private final ExecutorService registryCacheExecutor = Executors.newFixedThreadPool(1, new NamedThreadFactory("DubboSaveRegistryCache", true));
    // Is it synchronized to save the file
    private final boolean syncSaveFile;

    private class SaveProperties implements Runnable {
        private long version;

        private SaveProperties(long version) {
            this.version = version;
        }

        @Override
        public void run() {
            doSaveProperties(version);
        }
    }
    ...
}
----

== å¤±è´¥é‡è¯•å¤„ç†

ä½œä¸ºåˆ†å¸ƒå¼æœåŠ¡çš„æ³¨å†Œæ¨¡å—ï¼Œå…¶ç¨³å®šæ€§å’Œå®¹é”™æ€§çš„è¦æ±‚ä¼šæ¯”è¾ƒè‹›åˆ»ï¼Œç”±äºçœŸæ­£è´Ÿè´£æ³¨å†Œæ•°æ®å¤„ç†çš„æ˜¯éƒ¨ç½²åœ¨å¦ä¸€å°ä¸»æœºçš„Zookeeperã€etcdç­‰ç½‘ç»œèŠ‚ç‚¹ï¼Œè·¨è¶Šç½‘ç»œIO
çš„æ“ä½œçš„å¤±è´¥æ¦‚ç‡å¾ˆé«˜ï¼Œå› æ­¤å¯¹åº”åŠ¨ä½œç›¸åº”ä¹Ÿä¼šæœ‰ç€æ¯”è¾ƒé«˜çš„æ¦‚ç‡ä¼šå¤±è´¥ï¼Œä½œä¸ºæœåŠ¡å¯é æ€§ä¿éšœï¼Œé‡è¯•æœºåˆ¶çš„é‡è¦æ€§ä¸è¨€è€Œå–»ã€‚

ä»ä¸Šè¿°ä»£ç ä¸­æˆ‘ä»¬çŸ¥é“ï¼Œæ³¨å†Œä¸­å¿ƒæœ‰``notifyã€subscribeã€unsubscribeã€registerã€unregister``5ä¸ªä¸»è¦æ“ä½œï¼Œé‡è¯•ä¹Ÿå°±æ˜¯é’ˆå¯¹è¿™å‡ ä¸ªåŠ¨ä½œã€‚Dubboå¹¶æ²¡æœ‰
æŠŠè¿™éƒ¨åˆ†å®ç°åœ¨åŸºç±»``AbstractRegistry``ä¸­ï¼Œåšäº†æ‰©å±•å®ç°â€”â€”`FailbackRegistry`ï¼Œæ— è®ºæ˜¯æ¥å…¥Zookeeperè¿˜æ˜¯è¯¸å¦‚etcdç­‰å…¶ä»–ä½œä¸ºæ³¨å†Œä¸­å¿ƒçš„åˆ†å¸ƒå¼åä½œé—´
ï¼Œ__Dubbo__éƒ½è¦æ±‚èƒ½æä¾›å¤±è´¥é‡è¯•æœºåˆ¶ã€‚

`FailbackRegistry` ä¸­å®šä¹‰äº†å¦‚ä¸‹å‡ ä¸ªå¾…å­ç±»å®ç°å‘å…¶ä»–åˆ†å¸ƒå¼ä¸­é—´ä»¶å®ç°``subscribeã€unsubscribeã€registerã€unregister``è¿™4ä¸ªæ“ä½œçš„æ¨¡æ¿æŠ½è±¡æ–¹æ³•ï¼š
[source,java]
----
public abstract void doRegister(URL url);

public abstract void doUnregister(URL url);

public abstract void doSubscribe(URL url, NotifyListener listener);

public abstract void doUnsubscribe(URL url, NotifyListener listener);
----

å‚è€ƒlink:.\ä»£ç å°æŠ„.adoc[å®šæ—¶è½®ç®—æ³• Â· HashedWheelTimer]ï¼Œåœ¨å……åˆ†ç†è§£äº†å®šæ—¶è½®ç®—æ³•åï¼Œé‡è¯•å®ç°çš„åŸç†å…¶å®æ¯”è¾ƒå®¹æ˜“ç†è§£ã€‚

=== failedRegistered\failedUnregistered

å®ç°æ¯”è¾ƒç®€å•ï¼Œä»…ä»¥``failedRegistered``ä¸ºä¾‹ï¼š
[source,java]
----
public abstract class FailbackRegistry extends AbstractRegistry {
    ...
    private final ConcurrentMap<URL, FailedRegisteredTask> failedRegistered = new ConcurrentHashMap<URL, FailedRegisteredTask>();

    public void removeFailedRegisteredTask(URL url) {
        failedRegistered.remove(url);
    }

    private void addFailedRegistered(URL url) {
        FailedRegisteredTask oldOne = failedRegistered.get(url);
        if (oldOne != null) {
            return;
        }
        FailedRegisteredTask newTask = new FailedRegisteredTask(url, this);
        oldOne = failedRegistered.putIfAbsent(url, newTask);
        if (oldOne == null) {
            // never has a retry task. then start a new task for retry.
            retryTimer.newTimeout(newTask, retryPeriod, TimeUnit.MILLISECONDS);
        }
    }

    //åœ¨Providerå‘èµ·æˆ–è€…é‡è¯•registeræ“ä½œæ—¶å‡ä¼šè°ƒç”¨
    private void removeFailedRegistered(URL url) {
        FailedRegisteredTask f = failedRegistered.remove(url);
        if (f != null) {
            f.cancel();
        }
    }

    ConcurrentMap<URL, FailedRegisteredTask> getFailedRegistered() {
        return failedRegistered;
    }

    @Override
    public void register(URL url) {
        super.register(url);
        removeFailedRegistered(url);
        removeFailedUnregistered(url);
        try {
            // Sending a registration request to the server side
            doRegister(url);
        } catch (Exception e) {
            Throwable t = e;

            // If the startup detection is opened, the Exception is thrown directly.
            boolean check = getUrl().getParameter(Constants.CHECK_KEY, true)
                    && url.getParameter(Constants.CHECK_KEY, true)
                    && !CONSUMER_PROTOCOL.equals(url.getProtocol());
            boolean skipFailback = t instanceof SkipFailbackWrapperException;
            if (check || skipFailback) {
                if (skipFailback) {
                    t = t.getCause();
                }
                throw new IllegalStateException("Failed to register " + url + " to registry " + getUrl().getAddress() + ", cause: " + t.getMessage(), t);
            } else {
                logger.error("Failed to register " + url + ", waiting for retry, cause: " + t.getMessage(), t);
            }

            // Record a failed registration request to a failed list, retry regularly
            addFailedRegistered(url);
        }
    }

    public abstract void doRegister(URL url);
    ...
}
----
ä»ä»¥ä¸Šä»£ç ä¸éš¾å‘ç°ï¼Œå½“Providerå‘Registryå‘èµ·``register``æ—¶ï¼Œå¦‚æœè¯¥æ“ä½œå¤±è´¥ï¼Œè‹¥æœªå¼€å¯å¯åŠ¨æ£€æµ‹ç‰¹æ€§ï¼Œåˆ™ä¼šç»™å®šæ—¶è½®æ·»åŠ ä¸€ä¸ªé‡è¯•ä»»åŠ¡â€”â€”`FailedRegisteredTask`ï¼Œ
åè€…åœ¨è‹¥å¹²æ—¶é—´è·å¾—æŸä¸ªæ»´ç­”è¿è¡Œæ—¶æœºæ—¶ä¼šé‡æ–°æ‰§è¡Œ``doRegister``ï¼Œä»¥å®Œæˆåˆ°Zookeeperç­‰çš„æ³¨å†Œæ“ä½œã€‚

``FailedRegisteredTask``ä¸­é‡è¯•é€»è¾‘å¦‚ä¸‹ï¼Œå›è°ƒ``registry()``ï¼Œå†å°†è‡ªèº«è¿™ä¸ªä»»åŠ¡ä»``failedRegistered``è¿™ä¸ªä»»åŠ¡å®¹å™¨ä¸­ç§»é™¤ï¼š

[source,java]
registry.doRegister(url);
registry.removeFailedRegisteredTask(url);


=== failedSubscribed\failedUnsubscribed

è¿™ä¸‰è€…çš„é‡è¯•é€»è¾‘å’Œä¸Šè¿°åŸºæœ¬ç›¸åŒï¼Œåœ¨è¿›ä¸€æ­¥äº†è§£å‰ï¼Œå…ˆçœ‹çœ‹ä¸‹è¿°æºç ã€‚ä»ä¸Šæ–‡åˆ†æå¾—çŸ¥ï¼Œ__Consumer__è®¢é˜…äº‹ä»¶ï¼Œæ˜¯ç”±__Registry__æ ¹æ®å…¶URLå‚æ•°åˆ¤åˆ«æœ‰å“ªäº›æ³¨å†Œäº†çš„Provider
åŒ¹é…è¯¥__Consumer__çš„ï¼Œå› è€Œå…¶è‡ªèº«ï¼ˆç”±URLè¡¨å¾ï¼‰å’Œå…¶è®¢é˜…çš„NotifyListeneræ˜¯å¼ºç»‘å®šå…³ç³»ï¼Œå†æ ¹æ®é‡è¯•éœ€è¦å’Œç›¸åº”é‡è¯•Taskå½¢æˆå½¢å¦‚``<<URL,NotifyListener>,*Task>``
çš„ç»‘å®šå…³ç³»ã€‚
[source,java]
----
public abstract class FailbackRegistry extends AbstractRegistry {
    ...
    private final ConcurrentMap<Holder, FailedSubscribedTask> failedSubscribed =
        new ConcurrentHashMap<Holder, FailedSubscribedTask>();

    private final ConcurrentMap<Holder, FailedUnsubscribedTask> failedUnsubscribed =
        new ConcurrentHashMap<Holder, FailedUnsubscribedTask>();

    private final ConcurrentMap<Holder, FailedNotifiedTask> failedNotified =
        new ConcurrentHashMap<Holder, FailedNotifiedTask>();

    static class Holder {

        private final URL url;

        private final NotifyListener notifyListener;

        Holder(URL url, NotifyListener notifyListener) {
            if (url == null || notifyListener == null) {
                throw new IllegalArgumentException();
            }
            this.url = url;
            this.notifyListener = notifyListener;
        }

        @Override
        public int hashCode() {
            return url.hashCode() + notifyListener.hashCode();
        }

        @Override
        public boolean equals(Object obj) {
            if (obj instanceof Holder) {
                Holder h = (Holder) obj;
                return this.url.equals(h.url) && this.notifyListener.equals(h.notifyListener);
            } else {
                return false;
            }
        }
    }
    ...
}
----
Dubboè®¤ä¸ºåœ¨æ‰§è¡Œ``subscribe``æ“ä½œæ—¶ï¼Œå¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œé‚£ä¹ˆè¯´æ˜è´Ÿè´£æ‰¿æ‹…æ³¨å†Œä¸­å¿ƒè§’è‰²çš„Zookeeperç­‰ä¸­é—´ä»¶å‡ºç°äº†ç½‘ç»œæŠ–åŠ¨ï¼Œè¿™æ—¶ä¼šè°ƒç”¨``getCacheUrls(url)``
è·å–æœ€è¿‘ç¼“å­˜çš„æ‰€æœ‰åŒ¹é…å½“å‰__Consumer__å…³æ³¨çš„æ‰€æœ‰__Providers__ï¼Œæœ‰å€¼åˆ™ä¼šè°ƒç”¨``notify()``é€šçŸ¥è¯¥__Consumer__ï¼Œå¦åˆ™æ‰å‘èµ·é‡è¯•é€»è¾‘ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
[source,java]
----
public abstract class FailbackRegistry extends AbstractRegistry {
    ...
    public void subscribe(URL url, NotifyListener listener) {
        super.subscribe(url, listener);
        removeFailedSubscribed(url, listener);
        try {
            // Sending a subscription request to the server side
            doSubscribe(url, listener);
        } catch (Exception e) {
            Throwable t = e;

            List<URL> urls = getCacheUrls(url);
            if (CollectionUtils.isNotEmpty(urls)) {
                notify(url, listener, urls);
                logger.error("Failed to subscribe " + url + ", Using cached list: " + urls + " from cache file: "
                    + getUrl().getParameter(FILE_KEY, System.getProperty("user.home") + "/dubbo-registry-" + url.getHost() + ".cache") + ", cause: " + t.getMessage(), t);
            } else {
                // If the startup detection is opened, the Exception is thrown directly.
                boolean check = getUrl().getParameter(Constants.CHECK_KEY, true)
                        && url.getParameter(Constants.CHECK_KEY, true);
                boolean skipFailback = t instanceof SkipFailbackWrapperException;
                if (check || skipFailback) {
                    if (skipFailback) {
                        t = t.getCause();
                    }
                    throw new IllegalStateException("Failed to subscribe " + url + ", cause: " + t.getMessage(), t);
                } else {
                    logger.error("Failed to subscribe " + url + ", waiting for retry, cause: " + t.getMessage(), t);
                }
            }

            // Record a failed registration request to a failed list, retry regularly
            addFailedSubscribed(url, listener);
        }
    }
    ...
}
----

=== failedNotified
ä»ä¸Šæ–‡åˆ†æå¯çŸ¥``notify``å®é™…å®Œæˆçš„æ“ä½œæ˜¯ï¼Œå°±å¯¹åº”Consumeræ‰€å…³æ³¨çš„Providerå›è°ƒNotifyListeneräº‹ä»¶ï¼Œè€Œè¢«å…³æ³¨å¯¹è±¡åˆ—è¡¨æ—¶åŠ¨æ€å˜åŒ–çš„ï¼Œå› è€Œä¹Ÿ
å¯¼è‡´å¯¹åº”çš„``notify``æ“ä½œå®ç°æ¯”è¾ƒç‰¹æ®Šï¼Œä»¥ä¸‹æ˜¯å…¶æ‰€æœ‰ç›¸å…³æºç ã€‚
[source,java]
----
public abstract class FailbackRegistry extends AbstractRegistry {
    ...
    private void removeFailedSubscribed(URL url, NotifyListener listener) {
        Holder h = new Holder(url, listener);
        FailedSubscribedTask f = failedSubscribed.remove(h);
        if (f != null) {
            f.cancel();
        }
        removeFailedUnsubscribed(url, listener);
        removeFailedNotified(url, listener);
    }

    private void removeFailedNotified(URL url, NotifyListener listener) {
        Holder h = new Holder(url, listener);
        FailedNotifiedTask f = failedNotified.remove(h);
        if (f != null) {
            f.cancel();
        }
    }

    private void addFailedNotified(URL url, NotifyListener listener, List<URL> urls) {
        Holder h = new Holder(url, listener);
        FailedNotifiedTask newTask = new FailedNotifiedTask(url, listener);
        FailedNotifiedTask f = failedNotified.putIfAbsent(h, newTask);
        if (f == null) {
            // never has a retry task. then start a new task for retry.
            newTask.addUrlToRetry(urls);
            retryTimer.newTimeout(newTask, retryPeriod, TimeUnit.MILLISECONDS);
        } else {
            // just add urls which needs retry.
            newTask.addUrlToRetry(urls);
        }
    }


    @Override
    protected void notify(URL url, NotifyListener listener, List<URL> urls) {
        if (url == null) {
            throw new IllegalArgumentException("notify url == null");
        }
        if (listener == null) {
            throw new IllegalArgumentException("notify listener == null");
        }
        try {
            doNotify(url, listener, urls);
        } catch (Exception t) {
            // Record a failed registration request to a failed list, retry regularly
            addFailedNotified(url, listener, urls);
            logger.error("Failed to notify for subscribe " + url + ", waiting for retry, cause: " + t.getMessage(), t);
        }
    }

    ...
}


public final class FailedNotifiedTask extends AbstractRetryTask {

    private static final String NAME = "retry subscribe";

    private final NotifyListener listener;

    private final List<URL> urls = new CopyOnWriteArrayList<>();

    public FailedNotifiedTask(URL url, NotifyListener listener) {
        super(url, null, NAME);
        if (listener == null) {
            throw new IllegalArgumentException();
        }
        this.listener = listener;
    }

    public void addUrlToRetry(List<URL> urls) {
        if (CollectionUtils.isEmpty(urls)) {
            return;
        }
        this.urls.addAll(urls);
    }

    public void removeRetryUrl(List<URL> urls) {
        this.urls.removeAll(urls);
    }

    @Override
    protected void doRetry(URL url, FailbackRegistry registry, Timeout timeout) {
        if (CollectionUtils.isNotEmpty(urls)) {
            listener.notify(urls);
            urls.clear();
        }
        //åœ¨ä¸‹ä¸€ä¸ªå‘¨æœŸé‡è¯•å½“å‰Task
        reput(timeout, retryPeriod);
    }
}
----
ç”±å…¶å¯¹åº”çš„Taskå®šä¹‰å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœè¯¥Taskæ²¡æœ‰å› ä¸º``subscribe/unsubscribe``æ“ä½œè€Œè°ƒç”¨``removeFailedSubscribed``è¢«ç§»é™¤ï¼Œé‚£ä¹ˆè¯¥Taskä¼š
ä¸€ç›´å‘¨æœŸæ€§çš„è¿è¡Œä¸‹å»ï¼Œç”±``doRetry()``çš„é€»è¾‘â€”â€”åªæœ‰åŒ¹é…Providerçš„urlså®¹å™¨å†…å®¹ä¸ä¸ºç©ºçš„æ—¶å€™ï¼Œæ‰ä¼šå›è°ƒ``listener.notify()``æ‰§è¡Œå®é™…çš„é€šçŸ¥
æ“ä½œï¼Œå¹¶éšåæ¸…ç†è¯¥å®¹å™¨ï¼Œä¹Ÿå°±æ˜¯è¯´æŸä¸ªå›ºå®š``<URL,NotifyListener>``ç»‘å®šæ‰€å¯¹åº”çš„``FailedNotifiedTask``è¢«è®¾è®¡æˆå‘¨æœŸé‡è¯•ä»»åŠ¡ï¼Œå¹¶ä¸”ä¸€æ—¦æ·»åŠ 
å°±ä¼šé•¿æœŸç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œåç»­çš„__notify__é‡è¯•ï¼Œä»…ä»…æ˜¯å°†å¯¹åº”çš„åŒ¹é…__Provider__çš„__urls__åŠ å…¥åˆ°å…¶å®¹å™¨ä¸­ä»¥ç­‰å¾…ä¸‹ä¸€ä¸ªæ»´ç­”è¿è¡Œæ—¶åˆ»ã€‚


=== recover

æœ€åæœ‰ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„åœ°æ–¹æ˜¯ï¼Œ``recover()``æ–¹æ³•ä¹Ÿè¢«è¦†å†™äº†ï¼Œæ”¹ä¸ºè°ƒç”¨``addFailedRegistered(url)``å’Œ``addFailedSubscribed(url, listener)``ï¼Œ
ç”±å®šæ—¶è½®é©±åŠ¨å¼‚æ­¥å®Œæˆç›¸åº”çš„æ¢å¤å·¥ä½œã€‚

---

å®Œç»“